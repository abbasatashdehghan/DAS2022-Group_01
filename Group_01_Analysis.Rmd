---
title: "Group_01_Analysis.Rmd"
author: "Group_01"
date: "3/14/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, message=TRUE, warning=FALSE,error=TRUE, echo=TRUE}
library(tidyverse)
library(moderndive)
library(skimr)
library(readr)
library(Stat2Data)
library(ggplot2)
library(GGally)
library(broom)
library(sjPlot)
library(DescTools)
library(knitr)
library(gridExtra)
library(janitor)
library(dplyr)
```
# Introduction {#sec:Intro}

Dataset comes from the FIES (Family Income and Expenditure Survey) recorded in the Philippines. The survey, which is undertaken every three years, is aimed at providing data on family income and expenditure. In this study, we are going to identify the most influential variables on the number of people living in a household using a Generalised Linear Model. Below you can see an overview of the data and variables
```{r, message=FALSE, warning=F}
data <- read.csv("dataset1.csv", stringsAsFactors = T) %>% 
  rename("Number_of_Family"=7,"Income" = 1, "FoodExpenditure" = 3,
         "Gender" = 4, "Age" = 5,"Type" = 6, "Area" = 8,"HouseAge" = 9,
         "Bedrooms" = 10) %>% select(-2)

data$Type <- as.character(data$Type)
data$Type[data$Type == "Two or More Nonrelated Persons/Members"] <- 
  "Other"
 
#Region column removed from the data
  
glimpse(data)
```

$FoodExpenditure$ is the annual expenditure by the household on food (in Philippine peso)  
$Gender$ is the head of the households sex  
$Age$ is the head of the households age (in years)  
$Type$ is the relationship between the group of people living in the house  
$Number_of_Family$ is the number of people living in the house  
$Area$ is the floor area of the house (in $m^2$)  
$HouseAge$ is the age of the building (in years)  
$bedrooms$ is the number of bedrooms in the house  
$Electricity$ indicates that if the house have electricity? (1=Yes, 0=No)  

# Exploratory Data Analysis {#sec:EDA}
The following tables and graphs are produced to provide statistical summaries and graphs to see the distribution variables and their relationship and identify any possible outliers.

```{r data_summary}
# summary(data)
data[,-c(3,5,11)] %>% skim() %>% 
  select(skim_variable,numeric.p0,
                       numeric.mean, numeric.sd, numeric.p50, numeric.p100) %>% 
  kable(caption = "\\label{tabel:summary} Summary Statistics", 
        col.names = c("Variable", "Min", "Mean",
                                       "SD", "Median", "Max"),
        align = rep("c", 6), digits = 1)
```

Referring to \ref{tabel:summary}, the difference between mean and median indicates the presence of outliers in the data. The following pair plots fuhrer support the presence of outliers. 


```{r pairplot1, fig.cap="\\label{fig:pairplot1} The pair plot (first five variables) shows the relationship between each of the two variables", message=FALSE, warning=FALSE}
data[,c(1:6)] %>% ggpairs()

```

```{r pairplot2, fig.cap="\\label{fig:pairplot2} The pair plot (second five variables) shows the relationship between each of the two variables", message=FALSE, warning=FALSE}
data[,c(7:10, 6)] %>% ggpairs()

```

Figure \ref{fig:outliers} presents the distribution of outcome variables with regards to each of the continuous variables. The boxplots can help us identify the outliers 

```{r outliers, fig.cap="\\label{fig:outliers} The boxplot of the outcome variables vs each of the continuous explanatory variables", message=FALSE, warning=FALSE}
# Defining a fucntion to draw multiple boxplots for the outcome variables
graph_function <- function(x){
  ggplot(data = data, aes(x = "", y = get(x))) + 
    geom_boxplot(color = "steelblue") + 
    theme(legend.position = "none") + labs(y = x, x = "Number_of_Family_members") + 
    scale_y_continuous(limits = c(min(data[[x]])*0.9, max(data[[x]])*1.1)) + 
    stat_summary(fun.y = mean, geom = "errorbar", aes(ymax = ..y.., ymin = ..y..),
                 width = .75, linetype = "dashed") + 
    theme_classic() 
}  
#Boxplots of outcome variable vs other continous variables:
graphs <- lapply(names(data)[c(1,2,4,7,8,9)], graph_function)

grid.arrange(graphs[[1]],graphs[[2]],graphs[[3]],graphs[[4]],
                  graphs[[5]],graphs[[6]], ncol = 2)

```

Once the outliers are spotted and removed, the skewness in data is decreased as it can be seen in the Figure \ref{fig:outliersremoved}

```{r outliersremoved, fig.cap="\\label{fig:outliersremoved} The boxplot of the outcome variables vs each of the continuous explanatory variables after removing outliers", message=FALSE, warning=FALSE}

#Removing outliers 
data <- data %>% filter(Income < 830000 & Area < 500)

graphs_updated <- lapply(names(data)[c(1,2,4,7,8,9)], graph_function)

p <- grid.arrange(graphs_updated[[1]],graphs_updated[[2]],graphs_updated[[3]],
                  graphs_updated[[4]],graphs_updated[[5]],graphs_updated[[6]],
                  ncol = 2)

p
```
The table \ref{tabel:summary_outlier_removed} shows the summary statistics after removing outliers. The difference between medians and means are now narrower. 

```{r data_summary_outliers_removed}
data[,-c(3,5,11)] %>% skim() %>% 
  select(skim_variable,numeric.p0,
                       numeric.mean, numeric.sd, numeric.p50, numeric.p100) %>% 
  kable(caption = "\\label{tabel:summary_outlier_removed} Summary Statistics after outliers removed", 
        col.names = c("Variable", "Min", "Mean",
                                       "SD", "Median", "Max"),
        align = rep("c", 6), digits = 1)
```

The Figure \ref{fig:hist} shows the distribution of household sizes:

```{r hist, fig.cap="\\label{fig:hist} Distribtion of the size of families", message=FALSE, warning=FALSE}
plotdata = data %>% count(Number_of_Family) %>% 
  mutate(pct = n / sum(n),
         pctlabel = paste0(round(pct*100,1), "%"))
plotdata %>% ggplot(aes(x = Number_of_Family, y = n)) + 
  geom_col(stat = "identity", 
           fill = "indianred3", 
           color = "black")  +
   geom_text(aes(label = pctlabel), 
            vjust = -0.25) + 
  labs(x = "Number_of_Family", 
       y = "Frequency", 
       title  = "Histogram of the number of familiy members") + 
  theme_classic()

```
The histogram (Figure \ref{fig:hist} ) of the family size resembles a Poisson distribution.

# Formal Data Analysis
In this section we model the data to identify the most influential factors on the number of family members using Poisson distribution since the the outocme variabl is a count data. Then the goodness of fit comparison is made to select the best model based on AIC and Deviance. However, for the a Poisson to completly hold the variance and mean shall be equal. The variance and the mean are `r round(data$Number_of_Family %>% var(),1)` and `r round(data$Number_of_Family %>% mean(),1)`. We can say that they are roughly equal.

## Poisson  model
```{r poisson, echo=TRUE}
model.poisson = glm(data = data, Number_of_Family ~ Income + FoodExpenditure + 
                       Gender + Age + Type + Area + HouseAge + Bedrooms + Electricity,
                     family = poisson(link = "log"))
initial.poisson.AIC = model.poisson$aic
summary(model.poisson)
```
We now try to see if we can improve model AIC and decrease the deviance using step function. In this method we start from the full model and every time drop one variable and calculate the AIC. This procedure is continued until no further reduction in AIC is observed.
```{r PoissonAIC}
step(model.poisson)

model.poisson = glm(data = data, Number_of_Family ~ Income + FoodExpenditure + 
                       Gender + Age + Type + Area + HouseAge,
                     family = poisson)

summary(model.poisson)
```

By removing Electricity and Bedrooms, the AIC is reduced from `r round((initial.poisson.AIC),1)` to `r round((model.poisson$aic),1)`. We now check for the goodness of fit by comparing it against the null model. The 95 percent $\chi^2$(`r model.poisson$df.null - model.poisson$df.residual`) equals `r round(qchisq(df=model.poisson$df.null - model.poisson$df.residual, p=0.95), 1)`. Taking the difference in deviances (likelihood ratio test) results in the value of `r round((model.poisson$null.deviance - model.poisson$deviance),1)` which is significant when compared to `r round(qchisq(df=model.poisson$df.null - model.poisson$df.residual, p=0.95), 1)`. Therefore, there is no deviance of lack of fit with our model after removing the two variables of Electricity and Bedrooms. 
Given above, The formula below is proposed to model expected count:
$$log(Number\_ of\_Family) =\beta_0 + \beta_1 \cdot Income + \beta_2 \cdot FoodExpenditure + \beta_3 \cdot Gender + \beta_4 \cdot Age + 
\beta_5 \cdot Type + \beta_6 \cdot Area + \beta_7 \cdot HouseAge$$
                       
## Parameter estimates
Table \ref{tabel:parameterestimates} displays the parameter estimates. The main explanatory variables are significantly different from zero
```{r parameterestimates}
summary(model.poisson)$coefficients %>% 
   kable(caption = "\\label{tabel:parameterestimates} parameter estimates of the Poisson regression model", 
        col.names = c("Estimate", "Std. Error", "Test Statistic",
                                       "P.value"),
        align = rep("c", 4), digits = 3)
```

The rate ratio are obtained by exponentiating the coefficients(Table \ref{tabel:rateratio}). Figure \ref{fig:rateratiofig} exhibits the rate ration for the different explantory variables
```{r rateratio, warning=FALSE, message=FALSE}
cbind(exp(coef(model.poisson)), exp(confint(model.poisson))) %>% data.frame() %>% 
  rename("Estimate"=1, "Lower CI"=2, "Upper CI"=3) %>% 
  kable(caption = "\\label{tabel:rateratio} Rate ratios 95 percent confidence interval", digits = 2)
```

```{r rateratiofig, fig.cap="\\label{fig:rateratiofig} 95 percent rate ratios"}
plot_model(model.poisson, show.values = TRUE,
           title = "Rate ratio", show.p = FALSE, axis.lim = c(0.5,1.5))

```

```{r, warning=FALSE, message=FALSE}
plot_model(model.poisson, type = "pred", se = NULL)
```

Figure \ref illustrates the predictions of the the model. The differ3ence betwen real values and predictions can be seen in Figure \ref

```{r predictions, fig.cap="\\label{fig:predictions} Histogram of predictions of the number of family members"}

predictions = data %>% 
  mutate(pred = round(predict(model.poisson, type = "response"))) %>% count(pred)

predictions <- rbind(predictions, data.frame("pred" = c(1, 14, 15), n = rep(0,3))) %>% 
  arrange(pred)


predictions %>% mutate(pct = n / sum(n),
       pctlabel = paste0(round(pct*100,1), "%")) %>% 
  ggplot(aes(x = as.factor(pred), y = n)) + 
  geom_bar(stat = "identity", 
           fill = "steelblue", 
           color = "black")  +
  geom_text(aes(label = pctlabel), 
            vjust = -0.25) + 
  labs(x = "Family size", 
       y = "Frequency", 
       title  = "Prediction histogram of the number of familiy members") + 
  theme_classic() 


```

```{r comparison, fig.cap="\\label{fig:comparison} Comparison between real data and predictions"}

right_join(predictions[,c(1,2)], plotdata[,c(1,2)], by = c("pred" = "Number_of_Family")) %>% 
  gather(number, count, -pred) %>% rename("Family.size" = 1, "Group" = 2) %>% 
  mutate(Group = replace(Group, Group == "n.y", "Real count"),
         Group = replace(Group, Group == "n.x", "Prediction")) %>% 
    ggplot(aes(x = as.factor(Family.size), y = count, fill = Group)) +
  geom_col(position = position_dodge()) + 
  labs(x = "Family size")+
  scale_fill_manual(
    values = c("Real count" = "indianred3", "Prediction" = "steelblue"))+
  theme_classic()


```
